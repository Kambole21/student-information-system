{% extends 'layout.html' %}
{% block content %}

<link rel="stylesheet" type="text/css" href="{{url_for('static', filename='courses_programs.css')}}">
<div class="container-fluid">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="row">
        <!-- Schools Section -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Schools Management</h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addSchoolModal">
                        <i class="bi bi-plus-circle"></i> Add School
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Name</th>
                                    <th>Dean</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for school in schools %}
                                <tr>
                                    <td>{{ school.code }}</td>
                                    <td>{{ school.name }}</td>
                                    <td>{{ school.dean }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editSchoolModal"
                                                data-id="{{ school._id }}"
                                                data-name="{{ school.name }}"
                                                data-code="{{ school.code }}"
                                                data-dean="{{ school.dean }}"
                                                data-description="{{ school.description }}"
                                                data-status="{{ school.status }}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <a href="{{ url_for('courses_programs.delete_school', school_id=school._id) }}" 
                                           class="btn btn-sm btn-outline-danger"
                                           onclick="return confirm('Are you sure you want to delete this school?')">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Programs Section -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Programs Management</h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addProgramModal">
                        <i class="bi bi-plus-circle"></i> Add Program
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Code</th>
                                    <th>Name</th>
                                    <th>School</th>
                                    <th>Duration</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for program in programs %}
                                <tr>
                                    <td>{{ program.code }}</td>
                                    <td>{{ program.name }}</td>
                                    <td>{{ schools_dic[program.school_id|string] }}</td> <!-- School name column -->
                                    <td>{{ program.duration }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editProgramModal"
                                                data-id="{{ program._id }}"
                                                data-name="{{ program.name }}"
                                                data-code="{{ program.code }}"
                                                data-school-id="{{ program.school_id }}"
                                                data-duration="{{ program.duration }}"
                                                data-credits="{{ program.credits_required }}"
                                                data-description="{{ program.description }}"
                                                data-level="{{ program.level }}"
                                                data-status="{{ program.status }}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <a href="{{ url_for('courses_programs.delete_program', program_id=program._id) }}" 
                                           class="btn btn-sm btn-outline-danger"
                                           onclick="return confirm('Are you sure you want to delete this program?')">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Courses Section -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Courses Management</h5>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addCourseModal">
                        <i class="bi bi-plus-circle"></i> Add Course
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Name</th>
                                <th>Program</th>
                                <th>Credits</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                            <tbody>
                                {% for course in courses %}
                                <tr>
                                    <td>{{ course.code }}</td>
                                    <td>{{ course.name }}</td>
                                    <td>{{ programs_dic[course.program_id|string] }}</td> <!-- Program name column -->
                                    <td>{{ course.credits }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editCourseModal"
                                                data-id="{{ course._id }}"
                                                data-name="{{ course.name }}"
                                                data-code="{{ course.code }}"
                                                data-program-id="{{ course.program_id }}"
                                                data-credits="{{ course.credits }}"
                                                data-description="{{ course.description }}"
                                                data-semester="{{ course.semester }}"
                                                data-level="{{ course.level }}"
                                                data-prerequisites="{{ course.prerequisites|join(',') }}"
                                                data-status="{{ course.status }}">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <a href="{{ url_for('courses_programs.delete_course', course_id=course._id) }}" 
                                           class="btn btn-sm btn-outline-danger"
                                           onclick="return confirm('Are you sure you want to delete this course?')">
                                            <i class="bi bi-trash"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add School Modal -->
<div class="modal fade" id="addSchoolModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New School</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('courses_programs.add_school') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">School Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">School Code</label>
                        <input type="text" class="form-control" name="code" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Dean</label>
                        <input type="text" class="form-control" name="dean">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Add School</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit School Modal -->
<div class="modal fade" id="editSchoolModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit School</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editSchoolForm">
                <div class="modal-body">
                    <input type="hidden" name="school_id" id="editSchoolId">
                    <div class="mb-3">
                        <label class="form-label">School Name</label>
                        <input type="text" class="form-control" name="name" id="editSchoolName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">School Code</label>
                        <input type="text" class="form-control" name="code" id="editSchoolCode" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Dean</label>
                        <input type="text" class="form-control" name="dean" id="editSchoolDean">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" id="editSchoolDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status" id="editSchoolStatus">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Update School</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Program Modal -->
<div class="modal fade" id="addProgramModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Program</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('courses_programs.add_program') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Program Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Program Code</label>
                        <input type="text" class="form-control" name="code" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">School</label>
                        <select class="form-select" name="school_id" required>
                            <option value="">Select School</option>
                            {% for school in schools %}
                            <option value="{{ school._id }}">{{ school.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Duration</label>
                        <input type="text" class="form-control" name="duration" placeholder="e.g., 4 years" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Credits Required</label>
                        <input type="number" class="form-control" name="credits_required" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Level</label>
                        <select class="form-select" name="level">
                            <option value="undergraduate">Undergraduate</option>
                            <option value="postgraduate">Postgraduate</option>
                            <option value="diploma">Diploma</option>
                            <option value="certificate">Certificate</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Add Program</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Program Modal -->
<div class="modal fade" id="editProgramModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Program</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editProgramForm">
                <div class="modal-body">
                    <input type="hidden" name="program_id" id="editProgramId">
                    <div class="mb-3">
                        <label class="form-label">Program Name</label>
                        <input type="text" class="form-control" name="name" id="editProgramName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Program Code</label>
                        <input type="text" class="form-control" name="code" id="editProgramCode" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">School</label>
                        <select class="form-select" name="school_id" id="editProgramSchool" required>
                            {% for school in schools %}
                            <option value="{{ school._id }}">{{ school.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Duration</label>
                        <input type="text" class="form-control" name="duration" id="editProgramDuration" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Credits Required</label>
                        <input type="number" class="form-control" name="credits_required" id="editProgramCredits" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Level</label>
                        <select class="form-select" name="level" id="editProgramLevel">
                            <option value="undergraduate">Undergraduate</option>
                            <option value="postgraduate">Postgraduate</option>
                            <option value="diploma">Diploma</option>
                            <option value="certificate">Certificate</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" id="editProgramDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status" id="editProgramStatus">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Update Program</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Course Modal -->
<div class="modal fade" id="addCourseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('courses_programs.add_course') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Course Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Course Code</label>
                        <input type="text" class="form-control" name="code" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Program</label>
                       <select class="form-select" name="program_id" required>
                            <option value="">Select Program</option>
                            {% for program in programs %}
                            <option value="{{ program._id }}">{{ program.name }} ({{ schools_dic[program.school_id|string] }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Credits</label>
                        <input type="number" class="form-control" name="credits" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Semester</label>
                        <select class="form-select" name="semester">
                            <option value="1">Semester 1</option>
                            <option value="2">Semester 2</option>
                            <option value="3">Semester 3</option>
                            <option value="4">Semester 4</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Level</label>
                        <select class="form-select" name="level">
                            <option value="100">100 Level</option>
                            <option value="200">200 Level</option>
                            <option value="300">300 Level</option>
                            <option value="400">400 Level</option>
                            <option value="500">500 Level</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Prerequisites (comma separated)</label>
                        <input type="text" class="form-control" name="prerequisites" placeholder="e.g., MAT101,PHY101">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Add Course</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Course Modal -->
<!-- Edit Course Modal -->
<div class="modal fade" id="editCourseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editCourseForm">
                <div class="modal-body">
                    <input type="hidden" name="course_id" id="editCourseId">
                    <div class="mb-3">
                        <label class="form-label">Course Name</label>
                        <input type="text" class="form-control" name="name" id="editCourseName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Course Code</label>
                        <input type="text" class="form-control" name="code" id="editCourseCode" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Program</label>
                        <select class="form-select" name="program_id" id="editCourseProgram" required>
                            {% for program in programs %}
                            <option value="{{ program._id }}">{{ program.name }} ({{ schools_dic[program.school_id|string] }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Credits</label>
                        <input type="number" class="form-control" name="credits" id="editCourseCredits" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Semester</label>
                        <select class="form-select" name="semester" id="editCourseSemester">
                            <option value="1">Semester 1</option>
                            <option value="2">Semester 2</option>
                            <option value="3">Semester 3</option>
                            <option value="4">Semester 4</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Level</label>
                        <select class="form-select" name="level" id="editCourseLevel">
                            <option value="100">100 Level</option>
                            <option value="200">200 Level</option>
                            <option value="300">300 Level</option>
                            <option value="400">400 Level</option>
                            <option value="500">500 Level</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Prerequisites (comma separated)</label>
                        <input type="text" class="form-control" name="prerequisites" id="editCoursePrerequisites">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" id="editCourseDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status" id="editCourseStatus">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Update Course</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// School Modal Handler
document.getElementById('editSchoolModal').addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    var modal = this;
    
    modal.querySelector('#editSchoolId').value = button.getAttribute('data-id');
    modal.querySelector('#editSchoolName').value = button.getAttribute('data-name');
    modal.querySelector('#editSchoolCode').value = button.getAttribute('data-code');
    modal.querySelector('#editSchoolDean').value = button.getAttribute('data-dean');
    modal.querySelector('#editSchoolDescription').value = button.getAttribute('data-description');
    modal.querySelector('#editSchoolStatus').value = button.getAttribute('data-status');
    
    // Set form action
    modal.querySelector('#editSchoolForm').action = '/edit_school/' + button.getAttribute('data-id');
});

// Program Modal Handler
document.getElementById('editProgramModal').addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    var modal = this;
    
    modal.querySelector('#editProgramId').value = button.getAttribute('data-id');
    modal.querySelector('#editProgramName').value = button.getAttribute('data-name');
    modal.querySelector('#editProgramCode').value = button.getAttribute('data-code');
    modal.querySelector('#editProgramSchool').value = button.getAttribute('data-school-id');
    modal.querySelector('#editProgramDuration').value = button.getAttribute('data-duration');
    modal.querySelector('#editProgramCredits').value = button.getAttribute('data-credits');
    modal.querySelector('#editProgramDescription').value = button.getAttribute('data-description');
    modal.querySelector('#editProgramLevel').value = button.getAttribute('data-level');
    modal.querySelector('#editProgramStatus').value = button.getAttribute('data-status');
    
    // Set form action
    modal.querySelector('#editProgramForm').action = '/edit_program/' + button.getAttribute('data-id');
});

// Course Modal Handler
document.getElementById('editCourseModal').addEventListener('show.bs.modal', function (event) {
    var button = event.relatedTarget;
    var modal = this;
    
    modal.querySelector('#editCourseId').value = button.getAttribute('data-id');
    modal.querySelector('#editCourseName').value = button.getAttribute('data-name');
    modal.querySelector('#editCourseCode').value = button.getAttribute('data-code');
    modal.querySelector('#editCourseProgram').value = button.getAttribute('data-program-id');
    modal.querySelector('#editCourseCredits').value = button.getAttribute('data-credits');
    modal.querySelector('#editCourseDescription').value = button.getAttribute('data-description');
    modal.querySelector('#editCourseSemester').value = button.getAttribute('data-semester');
    modal.querySelector('#editCourseLevel').value = button.getAttribute('data-level');
    modal.querySelector('#editCoursePrerequisites').value = button.getAttribute('data-prerequisites');
    modal.querySelector('#editCourseStatus').value = button.getAttribute('data-status');
    
    // Set form action
    modal.querySelector('#editCourseForm').action = '/edit_course/' + button.getAttribute('data-id');
});

// Dynamic program loading based on school selection
document.querySelector('select[name="school_id"]').addEventListener('change', function() {
    var schoolId = this.value;
    var programSelect = document.querySelector('select[name="program_id"]');
    
    if (schoolId) {
        fetch('/get_programs/' + schoolId)
            .then(response => response.json())
            .then(programs => {
                programSelect.innerHTML = '<option value="">Select Program</option>';
                programs.forEach(program => {
                    programSelect.innerHTML += `<option value="${program.id}">${program.name}</option>`;
                });
            });
    } else {
        programSelect.innerHTML = '<option value="">Select Program</option>';
    }
});
</script>
{% endblock %}