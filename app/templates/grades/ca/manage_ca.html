{% extends 'layout.html' %}
{% block content %}

<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='ca.css') }}">
<div class="container-fluid">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-header ca-header">
                <h1><i class="bi bi-pencil-square"></i> Manage Continuous Assessments</h1>
                <p class="text-light">Enter and manage CA scores for students</p>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card search-section">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label class="form-label">Academic Year</label>
                            <select class="form-select" id="academicYear">
                                {% for year in academic_years %}
                                <option value="{{ year }}" {{ 'selected' if year == '2025/2026' }}>{{ year }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Semester</label>
                            <select class="form-select" id="semester">
                                {% for sem in semesters %}
                                <option value="{{ sem }}">Semester {{ sem }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">School</label>
                            <select class="form-select" id="schoolFilter">
                                <option value="">All Schools</option>
                                {% for school in schools %}
                                <option value="{{ school._id }}">{{ school.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Program</label>
                            <select class="form-select" id="programFilter">
                                <option value="">All Programs</option>
                                {% for program in programs %}
                                <option value="{{ program._id }}">{{ program.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Course Code</label>
                            <input type="text" class="form-control" id="courseCode" placeholder="e.g., CS101">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Course Name</label>
                            <input type="text" class="form-control" id="courseName" placeholder="e.g., Programming">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-8">
                            <div class="input-group">
                                <input type="text" class="form-control" id="searchInput" placeholder="Search by student name or number...">
                                <button class="btn btn-ca-primary" type="button" onclick="searchStudents()">
                                    <i class="bi bi-search"></i> Search Students
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="bi bi-arrow-clockwise"></i> Clear Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="row mb-4">
        <!-- Students List - Wider Column -->
        <div class="col-md-5">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-people"></i> Students</h5>
                    <div>
                        <span class="badge bg-primary" id="studentsCount">0 students</span>
                        <button class="btn btn-sm btn-outline-primary ms-2" onclick="viewStudentCA()" id="viewStudentBtn" disabled>
                            <i class="bi bi-eye"></i> View CA
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="studentsList" class="list-group list-group-flush student-list-container">
                        <div class="text-center text-muted py-4">
                            <i class="bi bi-people display-4"></i>
                            <p>Use search filters to find students</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CA Scores Form - Wider Column -->
        <div class="col-md-7">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-clipboard-data"></i> Continuous Assessment Scores</h5>
                    <div id="studentInfo" class="d-none">
                        <span class="badge bg-primary" id="selectedStudentInfo"></span>
                    </div>
                </div>
                <div class="card-body">
                    <div id="noStudentSelected" class="text-center py-5">
                        <i class="bi bi-person-x display-4 text-muted"></i>
                        <h5 class="text-muted mt-3">No Student Selected</h5>
                        <p class="text-muted">Please select a student from the list to enter CA scores</p>
                    </div>

                    <div id="caFormContainer" class="d-none">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <strong>Academic Year:</strong> <span id="currentAcademicYear"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>Semester:</strong> <span id="currentSemester"></span>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table table-bordered ca-table">
                                <thead>
                                    <tr>
                                        <th>Course Code</th>
                                        <th>Course Name</th>
                                        <th>CA Score</th>
                                        <th>Total CA</th>
                                        <th>Percentage</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="caScoresTable">
                                    <!-- CA scores will be populated here -->
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-3 d-flex gap-2">
                            <button class="btn btn-ca-primary" onclick="saveCAScores()">
                                <i class="bi bi-save"></i> Save All Scores
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearSelection()">
                                <i class="bi bi-x-circle"></i> Clear Selection
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assessment Breakdown Modal -->
<div class="modal fade" id="assessmentBreakdownModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Assessment Breakdown - <span id="modalCourseName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-bordered breakdown-table">
                        <thead>
                            <tr>
                                <th>Assessment Type</th>
                                <th>Score</th>
                                <th>Max Score</th>
                                <th>Percentage</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="breakdownTable">
                            <!-- Breakdown items will be populated here -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="2"><strong>Total Score:</strong></td>
                                <td><strong id="totalMaxScore">40</strong></td>
                                <td><strong id="totalPercentage">0%</strong></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="row mt-3">
                    <div class="col-md-4">
                        <label>Assessment Type</label>
                        <select class="form-select" id="newAssessmentType">
                            <option value="assignment">Assignment</option>
                            <option value="quiz">Quiz</option>
                            <option value="project">Project</option>
                            <option value="lab">Lab Work</option>
                            <option value="presentation">Presentation</option>
                            <option value="participation">Class Participation</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label>Score</label>
                        <input type="number" class="form-control" id="newAssessmentScore" min="0" step="0.1" placeholder="Score">
                    </div>
                    <div class="col-md-3">
                        <label>Max Score</label>
                        <input type="number" class="form-control" id="newAssessmentMax" min="1" step="1" value="10" placeholder="Max">
                    </div>
                    <div class="col-md-2">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary w-100" onclick="addAssessmentItem()">
                            <i class="bi bi-plus"></i> Add
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveBreakdown()">Save Breakdown</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
let selectedStudentId = null;
let currentCourseId = null;
let assessmentBreakdown = [];

function searchStudents() {
    const searchTerm = document.getElementById('searchInput').value;
    const schoolId = document.getElementById('schoolFilter').value;
    const programId = document.getElementById('programFilter').value;
    const academicYear = document.getElementById('academicYear').value;
    const semester = document.getElementById('semester').value;
    const courseCode = document.getElementById('courseCode').value;
    const courseName = document.getElementById('courseName').value;

    fetch(`/ca/search_students?search=${encodeURIComponent(searchTerm)}&school_id=${schoolId}&program_id=${programId}&academic_year=${academicYear}&semester=${semester}&course_code=${courseCode}&course_name=${courseName}`)
        .then(response => response.json())
        .then(students => {
            const studentsList = document.getElementById('studentsList');
            studentsList.innerHTML = '';

            if (students.length === 0) {
                studentsList.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-search display-4"></i>
                        <p>No students found matching your criteria</p>
                    </div>
                `;
                document.getElementById('studentsCount').textContent = '0 students';
                return;
            }

            document.getElementById('studentsCount').textContent = `${students.length} students`;

            students.forEach(student => {
                const studentElement = document.createElement('div');
                studentElement.className = `list-group-item list-group-item-action student-ca-card ${selectedStudentId === student.id ? 'selected' : ''}`;
                studentElement.innerHTML = `
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${student.f_name} ${student.l_name}</h6>
                            <p class="mb-1 text-muted small">${student.student_number}</p>
                            <small class="text-muted">${student.program_name} â€¢ ${student.school_name}</small>
                        </div>
                        <div class="text-end">
                            <small class="badge bg-light text-dark">${student.enrolled_courses_count} courses</small>
                        </div>
                    </div>
                `;
                studentElement.onclick = () => selectStudent(student.id, student);
                studentsList.appendChild(studentElement);
            });
        })
        .catch(error => {
            console.error('Error searching students:', error);
            alert('Error searching students');
        });
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('schoolFilter').value = '';
    document.getElementById('programFilter').value = '';
    document.getElementById('courseCode').value = '';
    document.getElementById('courseName').value = '';
    searchStudents();
}

function selectStudent(studentId, student) {
    selectedStudentId = studentId;
    
    // Update UI
    document.querySelectorAll('.student-ca-card').forEach(card => {
        card.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
    
    // Enable view button
    document.getElementById('viewStudentBtn').disabled = false;
    
    // Show student info
    document.getElementById('studentInfo').classList.remove('d-none');
    document.getElementById('selectedStudentInfo').textContent = `${student.f_name} ${student.l_name} (${student.student_number})`;
    
    // Show CA form
    document.getElementById('noStudentSelected').classList.add('d-none');
    document.getElementById('caFormContainer').classList.remove('d-none');
    
    // Set current academic year and semester
    document.getElementById('currentAcademicYear').textContent = document.getElementById('academicYear').value;
    document.getElementById('currentSemester').textContent = document.getElementById('semester').value;
    
    // Load student courses
    loadStudentCourses(studentId);
}

function viewStudentCA() {
    if (selectedStudentId) {
        window.open(`/ca/student/${selectedStudentId}`, '_blank');
    }
}

function loadStudentCourses(studentId) {
    const academicYear = document.getElementById('academicYear').value;
    const semester = document.getElementById('semester').value;

    fetch(`/ca/get_student_courses/${studentId}?academic_year=${academicYear}&semester=${semester}`)
        .then(response => response.json())
        .then(courses => {
            const caScoresTable = document.getElementById('caScoresTable');
            caScoresTable.innerHTML = '';

            courses.forEach(course => {
                const percentage = course.ca_score ? ((course.ca_score / course.total_score) * 100).toFixed(1) : 0;
                const percentageClass = percentage >= 50 ? 'text-success' : percentage >= 40 ? 'text-warning' : 'text-danger';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${course.course_code}</strong></td>
                    <td>${course.course_name}</td>
                    <td>
                        <input type="number" class="form-control ca-score-input" 
                               value="${course.ca_score || ''}" 
                               min="0" max="${course.total_score}" step="0.1"
                               data-course-id="${course.course_id}"
                               onchange="updatePercentage(this)">
                    </td>
                    <td>
                        <input type="number" class="form-control ca-total-score-input" 
                               value="${course.total_score}" 
                               min="1" max="100" step="1"
                               data-course-id="${course.course_id}"
                               readonly>
                    </td>
                    <td>
                        <span class="percentage-badge badge ${percentageClass}">${percentage}%</span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="openBreakdownModal('${course.course_id}', '${course.course_code} - ${course.course_name}')">
                            <i class="bi bi-gear"></i> Configure
                        </button>
                    </td>
                `;
                caScoresTable.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Error loading student courses:', error);
            alert('Error loading student courses');
        });
}

function updatePercentage(input) {
    const row = input.closest('tr');
    const scoreInput = row.querySelector('.ca-score-input');
    const totalInput = row.querySelector('.ca-total-score-input');
    const percentageBadge = row.querySelector('.percentage-badge');
    
    const score = parseFloat(scoreInput.value) || 0;
    const total = parseFloat(totalInput.value) || 1;
    const percentage = total > 0 ? (score / total * 100).toFixed(1) : 0;
    
    const percentageClass = percentage >= 50 ? 'text-success' : percentage >= 40 ? 'text-warning' : 'text-danger';
    percentageBadge.className = `percentage-badge badge ${percentageClass}`;
    percentageBadge.textContent = `${percentage}%`;
}

function openBreakdownModal(courseId, courseName) {
    currentCourseId = courseId;
    document.getElementById('modalCourseName').textContent = courseName;
    
    // Load existing breakdown for this course
    const courseRow = document.querySelector(`.ca-score-input[data-course-id="${courseId}"]`).closest('tr');
    const existingScore = courseRow.querySelector('.ca-score-input').value;
    
    // Try to load existing breakdown from server or initialize empty
    fetch(`/ca/get_breakdown/${selectedStudentId}/${courseId}?academic_year=${document.getElementById('academicYear').value}&semester=${document.getElementById('semester').value}`)
        .then(response => response.json())
        .then(data => {
            if (data.breakdown && data.breakdown.length > 0) {
                assessmentBreakdown = data.breakdown;
            } else if (existingScore) {
                // If there's an existing score but no breakdown, create a default one
                assessmentBreakdown = [{
                    type: 'assignment',
                    name: 'Assignment 1',
                    score: parseFloat(existingScore),
                    max_score: 40
                }];
            } else {
                assessmentBreakdown = [];
            }
            updateBreakdownTable();
        })
        .catch(error => {
            console.error('Error loading breakdown:', error);
            assessmentBreakdown = [];
            updateBreakdownTable();
        });
    
    new bootstrap.Modal(document.getElementById('assessmentBreakdownModal')).show();
}

function updateBreakdownTable() {
    const breakdownTable = document.getElementById('breakdownTable');
    breakdownTable.innerHTML = '';
    
    let totalScore = 0;
    let totalMax = 0;
    
    assessmentBreakdown.forEach((item, index) => {
        const percentage = item.max_score > 0 ? ((item.score / item.max_score) * 100).toFixed(1) : 0;
        totalScore += item.score;
        totalMax += item.max_score;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <strong>${item.name || item.type.charAt(0).toUpperCase() + item.type.slice(1)}</strong>
                <br><small class="text-muted">${item.type.charAt(0).toUpperCase() + item.type.slice(1)}</small>
            </td>
            <td>${item.score}</td>
            <td>${item.max_score}</td>
            <td>${percentage}%</td>
            <td>
                <button class="btn btn-sm btn-outline-danger" onclick="removeAssessmentItem(${index})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        breakdownTable.appendChild(row);
    });
    
    document.getElementById('totalMaxScore').textContent = totalMax;
    document.getElementById('totalPercentage').textContent = totalMax > 0 ? ((totalScore / totalMax) * 100).toFixed(1) + '%' : '0%';
}

function addAssessmentItem() {
    const type = document.getElementById('newAssessmentType').value;
    const score = parseFloat(document.getElementById('newAssessmentScore').value) || 0;
    const maxScore = parseFloat(document.getElementById('newAssessmentMax').value) || 10;
    
    if (score > maxScore) {
        alert('Score cannot be greater than maximum score');
        return;
    }
    
    // Count existing items of this type to create numbered names
    const existingItemsOfType = assessmentBreakdown.filter(item => item.type === type);
    const itemNumber = existingItemsOfType.length + 1;
    const itemName = `${type.charAt(0).toUpperCase() + type.slice(1)} ${itemNumber}`;
    
    assessmentBreakdown.push({
        type: type,
        name: itemName,
        score: score,
        max_score: maxScore
    });
    
    // Clear input fields
    document.getElementById('newAssessmentScore').value = '';
    document.getElementById('newAssessmentMax').value = '10';
    
    updateBreakdownTable();
}

function removeAssessmentItem(index) {
    assessmentBreakdown.splice(index, 1);
    updateBreakdownTable();
}

function saveBreakdown() {
    if (currentCourseId) {
        const totalScore = assessmentBreakdown.reduce((sum, item) => sum + item.score, 0);
        const totalMax = assessmentBreakdown.reduce((sum, item) => sum + item.max_score, 0);
        
        // Update the main form
        const courseRow = document.querySelector(`.ca-score-input[data-course-id="${currentCourseId}"]`).closest('tr');
        courseRow.querySelector('.ca-score-input').value = totalScore;
        courseRow.querySelector('.ca-total-score-input').value = totalMax;
        
        // Update percentage
        updatePercentage(courseRow.querySelector('.ca-score-input'));
        
        // Save breakdown to server
        fetch(`/ca/save_breakdown/${selectedStudentId}/${currentCourseId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                academic_year: document.getElementById('academicYear').value,
                semester: document.getElementById('semester').value,
                breakdown: assessmentBreakdown
            })
        })
        .then(response => response.json())
        .then(result => {
            if (!result.success) {
                console.error('Error saving breakdown:', result.error);
            }
        })
        .catch(error => {
            console.error('Error saving breakdown:', error);
        });
        
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('assessmentBreakdownModal')).hide();
    }
}

function saveCAScores() {
    if (!selectedStudentId) {
        alert('Please select a student first');
        return;
    }

    const academicYear = document.getElementById('academicYear').value;
    const semester = document.getElementById('semester').value;
    
    const caScores = [];
    document.querySelectorAll('#caScoresTable tr').forEach(row => {
        const scoreInput = row.querySelector('.ca-score-input');
        const totalInput = row.querySelector('.ca-total-score-input');
        
        if (scoreInput && totalInput) {
            caScores.push({
                course_id: scoreInput.dataset.courseId,
                score: scoreInput.value ? parseFloat(scoreInput.value) : null,
                total_score: parseFloat(totalInput.value),
                assessment_date: new Date().toISOString().split('T')[0]
            });
        }
    });

    fetch(`/ca/save_scores/${selectedStudentId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            academic_year: academicYear,
            semester: semester,
            ca_scores: caScores
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert(result.message);
            // Reload courses to show updated scores
            loadStudentCourses(selectedStudentId);
        } else {
            alert('Error saving scores: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error saving scores:', error);
        alert('Error saving scores');
    });
}

function clearSelection() {
    selectedStudentId = null;
    document.getElementById('studentInfo').classList.add('d-none');
    document.getElementById('caFormContainer').classList.add('d-none');
    document.getElementById('noStudentSelected').classList.remove('d-none');
    document.getElementById('viewStudentBtn').disabled = true;
    document.querySelectorAll('.student-ca-card').forEach(card => {
        card.classList.remove('selected');
    });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    searchStudents();
});
</script>
{% endblock %}