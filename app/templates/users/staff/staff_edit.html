{% extends 'layout.html' %}
{% block content %}

<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='staff.css') }}">
<div class="container-fluid">
    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="page-header">
                <h1><i class="bi bi-pencil-square"></i> Edit Staff Member</h1>
                <p class="text-muted">Update staff information and permissions</p>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10-fluid">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-person-gear"></i> Edit {{ staff.f_name }} {{ staff.l_name }}</h5>

                    {% if privilege_level in ['academics', 'dean', 'registrar, admin_dvc', 'admin_vc', 'admin', 'ict'] %}
                    <a href="{{ url_for('staff.staff_list') }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-arrow-left"></i> Back to Staff List
                    </a>
                    {% endif %}
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('staff.update_staff', staff_id=staff._id) }}" enctype="multipart/form-data" id="editStaffForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">First Name *</label>
                                    <input type="text" class="form-control" name="f_name" value="{{ staff.f_name }}" required {% if session.privilege_level in ['tutor', 'snr_tutor', 'lecturer', 'accounts', 'hall_attendant' ] %} readonly{% endif %}>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Last Name *</label>
                                    <input type="text" class="form-control" name="l_name" value="{{ staff.l_name }}" required{% if session.privilege_level in ['tutor', 'snr_tutor', 'lecturer', 'accounts', 'hall_attendant' ] %} readonly{% endif %}>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Email *</label>
                                    <input type="email" class="form-control" name="email" value="{{ staff.email }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Username *</label>
                                    <input type="text" class="form-control" name="username" value="{{ staff.username }}" required {% if session.privilege_level in ['tutor', 'snr_tutor', 'lecturer', 'accounts', 'hall_attendant'] %} readonly{% endif %}>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Password</label>
                                    <input type="password" class="form-control" name="password" placeholder="Leave blank to keep current password">
                                    <div class="form-text">Only enter if you want to change the password</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Phone Number *</label>
                                    <input type="tel" class="form-control" name="phone_number" value="{{ staff.phone_number }}" required>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Residential Address</label>
                            <textarea class="form-control" name="residential_address" rows="2">{{ staff.residential_address }}</textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Town/City</label>
                                    <input type="text" class="form-control" name="town" value="{{ staff.town }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Country</label>
                                    <input type="text" class="form-control" name="country" value="{{ staff.country }}">
                                </div>
                            </div>
                        </div>

                        {% if session.privilege_level in ['ict', 'admin', 'admin_vc', 'admin_dvc', 'registrar'] %}

                                                <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Role/Privilege Level *</label>
                                    <select class="form-select" name="privilege_level" id="privilegeLevel" required>
                                        <option value="">Select Role</option>
                                        <option value="press" {% if staff.privilege_level == 'press' %}selected{% endif %}>Press</option>
                                        <option value="tutor" {% if staff.privilege_level == 'tutor' %}selected{% endif %}>Tutor</option>
                                        <option value="snr_tutor" {% if staff.privilege_level == 'snr_tutor' %}selected{% endif %}>Tutor</option>
                                        <option value="lecturer" {% if staff.privilege_level == 'lecturer' %}selected{% endif %}>Lecturer</option>
                                        <option value="hod" {% if staff.privilege_level == 'hod' %}selected{% endif %}>Head of Department (HOD)</option>
                                        <option value="deputy_dean" {% if staff.privilege_level == 'deputy_dean' %}selected{% endif %}>Deputy Dean</option>
                                        <option value="dean" {% if staff.privilege_level == 'dean' %}selected{% endif %}>Dean</option>
                                        <option value="dean_of_students" {% if staff.privilege_level == 'dean_of_students' %}selected{% endif %}>Dean of Students</option>
                                        <option value="accounts" {% if staff.privilege_level == 'accounts' %}selected{% endif %}>Accounts</option>
                                        <option value="hall_attendant" {% if staff.privilege_level == 'hall_attendant' %}selected{% endif %}>Hall Attendant</option>
                                        <option value="registrar" {% if staff.privilege_level == 'registrar' %}selected{% endif %}>Registrar</option>
                                        <option value="ict" {% if staff.privilege_level == 'ict' %}selected{% endif %}>ICT</option>
                                        <option value="academics" {% if staff.privilege_level == 'academics' %}selected{% endif %}>Academics</option>
                                        <option value="admin" {% if staff.privilege_level == 'admin' %}selected{% endif %}>Administrator</option>
                                        <option value="ict_beta" {% if staff.privilege_level == 'ict_beta' %}selected{% endif %}>ICT beta</option>
                                        <option value="admin_dvc" {% if staff.privilege_level == 'admin_dvc' %}selected{% endif %}>Deputy V.C</option> 
                                        <option value="admin_vc" {% if staff.privilege_level == 'admin_vc' %}selected{% endif %}>V.C</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" name="status">
                                        <option value="active" {% if staff.status == 'active' %}selected{% endif %}>Active</option>
                                        <option value="inactive" {% if staff.status == 'inactive' %}selected{% endif %}>Inactive</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        {% endif %}

                        <!-- School Selection (for school-based roles) -->
                        <div class="mb-3" id="schoolField" style="display: none;">
                            <label class="form-label">School</label>
                            <select class="form-select" name="school_id" id="schoolSelect">
                                <option value="">Select School</option>
                                {% for school in schools %}
                                <option value="{{ school._id }}" {% if staff.school_id == school._id|string %}selected{% endif %}>{{ school.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Department Input -->
                        <div class="mb-3" id="departmentField" style="display: none;">
                            <label class="form-label">Department</label>
                            <input type="text" class="form-control" name="department" id="departmentInput" value="{{ staff.department }}" placeholder="Enter department name">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Profile Image</label>
                            <div class="d-flex align-items-center mb-2">
                                <img src="{{ url_for('static', filename='uploads/staff/' + staff.profile_image) if staff.profile_image != 'profile.svg' else url_for('static', filename='images/profile.svg') }}" 
                                     alt="{{ staff.f_name }} {{ staff.l_name }}" 
                                     class="staff-photo-large me-3">
                                <div>
                                    <div>Current Image</div>
                                    <small class="text-muted">Upload new image to replace</small>
                                </div>
                            </div>
                            <input type="file" class="form-control" name="profile_image" accept="image/*">
                            <div class="form-text">Allowed formats: PNG, JPG, JPEG, GIF</div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('staff.staff_list') }}" class="btn btn-outline-secondary me-md-2">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Update Staff Member
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const privilegeSelect = document.getElementById('privilegeLevel');
    const schoolField = document.getElementById('schoolField');
    const schoolSelect = document.getElementById('schoolSelect');
    const departmentField = document.getElementById('departmentField');
    const departmentInput = document.getElementById('departmentInput');

    // Roles that require school selection
    const schoolBasedRoles = ['lecturer', 'hod', 'deputy_dean', 'dean'];
    
    // Roles that require department input
    const departmentBasedRoles = ['lecturer', 'hod'];

    function updateFormFields() {
        const selectedRole = privilegeSelect.value;
        
        // Show/hide school field
        if (schoolBasedRoles.includes(selectedRole)) {
            schoolField.style.display = 'block';
        } else {
            schoolField.style.display = 'none';
            schoolSelect.value = '';
        }

        // Show/hide department field
        if (departmentBasedRoles.includes(selectedRole)) {
            departmentField.style.display = 'block';
        } else {
            departmentField.style.display = 'none';
            departmentInput.value = '';
        }
    }

    // Initialize form fields on page load
    updateFormFields();

    privilegeSelect.addEventListener('change', updateFormFields);
});
</script>
{% endblock %}